<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting...</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .redirect-container { background: white; border-radius: 15px; padding: 40px; max-width: 600px; width: 100%; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        
        .redirect-icon { font-size: 4rem; margin-bottom: 20px; }
        
        h1 { color: #333; margin-bottom: 15px; }
        p { color: #666; margin-bottom: 25px; line-height: 1.6; }
        
        .countdown { font-size: 3rem; color: #667eea; font-weight: bold; margin: 20px 0; }
        
        .password-form, .email-form { margin: 20px 0; }
        input[type="password"], input[type="email"], input[type="text"] { 
            width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 15px; 
        }
        input:focus { border-color: #667eea; outline: none; }
        
        button { 
            background: #667eea; color: white; border: none; padding: 15px 30px; 
            border-radius: 8px; font-size: 16px; cursor: pointer; width: 100%; 
            margin: 10px 0; transition: background 0.3s;
        }
        button:hover { background: #5a67d8; }
        
        .custom-content { text-align: left; background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; }
        
        .hint { color: #888; font-size: 14px; margin-top: 5px; }
        
        .progress-bar { height: 8px; background: #eee; border-radius: 4px; margin: 20px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: #667eea; width: 0%; transition: width 1s linear; }
    </style>
</head>
<body>
    <div class="redirect-container" id="redirectContainer">
        <!-- Content will be dynamically loaded -->
        <div class="redirect-icon">‚è≥</div>
        <h1>Loading...</h1>
        <p>Please wait while we process your request.</p>
    </div>

    <script>
        // Get short code from URL
        const pathParts = window.location.pathname.split('/');
        const shortCode = pathParts[pathParts.length - 1] || '';
        
        // Simulate getting data from database
        // In real implementation, this would be an API call
        function getRedirectData(code) {
            const data = localStorage.getItem(`pgxl_${code}`);
            return data ? JSON.parse(data) : null;
        }
        
        // Handle different redirect types
        function handleRedirect(data) {
            const container = document.getElementById('redirectContainer');
            
            switch(data.type) {
                case 'direct':
                    // Redirect immediately
                    window.location.href = data.longUrl;
                    break;
                    
                case 'wait':
                    showWaitPage(container, data);
                    break;
                    
                case 'password':
                    showPasswordPage(container, data);
                    break;
                    
                case 'html':
                    showCustomHtml(container, data);
                    break;
                    
                case 'email':
                    showEmailGate(container, data);
                    break;
                    
                default:
                    container.innerHTML = `
                        <h1>Invalid Link</h1>
                        <p>This short URL is not configured properly.</p>
                        <button onclick="window.location.href='/'">Go Home</button>
                    `;
            }
        }
        
        // ======================
        // WAIT PAGE
        // ======================
        function showWaitPage(container, data) {
            const waitTime = data.settings.waitTime || 5;
            let seconds = waitTime;
            
            container.innerHTML = `
                <div class="redirect-icon">‚è≥</div>
                <h1>${data.settings.title || 'Please Wait'}</h1>
                <p>${data.settings.message.replace('{seconds}', seconds) || `Redirecting in ${seconds} seconds...`}</p>
                <div class="countdown" id="countdown">${seconds}</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <button onclick="skipWait()">Skip Waiting</button>
            `;
            
            // Start countdown
            const countdownEl = document.getElementById('countdown');
            const progressEl = document.getElementById('progressFill');
            
            const interval = setInterval(() => {
                seconds--;
                countdownEl.textContent = seconds;
                progressEl.style.width = `${((waitTime - seconds) / waitTime) * 100}%`;
                
                if (seconds <= 0) {
                    clearInterval(interval);
                    window.location.href = data.longUrl;
                }
            }, 1000);
            
            window.skipWait = function() {
                clearInterval(interval);
                window.location.href = data.longUrl;
            };
        }
        
        // ======================
        // PASSWORD PAGE
        // ======================
        function showPasswordPage(container, data) {
            container.innerHTML = `
                <div class="redirect-icon">üîí</div>
                <h1>Password Required</h1>
                <p>This link is protected by a password.</p>
                ${data.settings.hint ? `<p class="hint">Hint: ${data.settings.hint}</p>` : ''}
                <div class="password-form">
                    <input type="password" id="passwordInput" placeholder="Enter password" autofocus>
                    <button onclick="checkPassword()">Continue</button>
                </div>
                <p style="font-size: 14px; color: #888;">Press Enter after typing password</p>
            `;
            
            // Enter key support
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') checkPassword();
            });
            
            window.checkPassword = function() {
                const input = document.getElementById('passwordInput').value;
                if (input === data.settings.password) {
                    window.location.href = data.longUrl;
                } else {
                    alert('Incorrect password!');
                    document.getElementById('passwordInput').value = '';
                    document.getElementById('passwordInput').focus();
                }
            };
        }
        
        // ======================
        // CUSTOM HTML PAGE
        // ======================
        function showCustomHtml(container, data) {
            container.innerHTML = `
                <div class="redirect-icon">üé®</div>
                <h1>${data.settings.title || 'Welcome!'}</h1>
                <div class="custom-content">
                    ${data.settings.message || 'Click continue to proceed to the destination.'}
                </div>
                <button onclick="proceed()">Continue to Destination</button>
                <button onclick="window.location.href='/'" style="background: #6c757d;">Cancel</button>
            `;
            
            window.proceed = function() {
                window.location.href = data.longUrl;
            };
        }
        
        // ======================
        // EMAIL GATE
        // ======================
        function showEmailGate(container, data) {
            container.innerHTML = `
                <div class="redirect-icon">üìß</div>
                <h1>Email Required</h1>
                <p>${data.settings.emailMessage || 'Please enter your email to continue'}</p>
                <div class="email-form">
                    <input type="email" id="emailInput" placeholder="your@email.com" autofocus>
                    <button onclick="submitEmail()">Submit & Continue</button>
                </div>
                <p style="font-size: 14px; color: #888;">We'll only use this to notify you of updates</p>
            `;
            
            window.submitEmail = function() {
                const email = document.getElementById('emailInput').value;
                if (email && email.includes('@')) {
                    // Save email (in real app, send to API)
                    console.log('Email collected:', email);
                    alert('Thank you! Redirecting...');
                    window.location.href = data.longUrl;
                } else {
                    alert('Please enter a valid email address');
                }
            };
        }
        
        // ======================
        // INITIALIZE
        // ======================
        window.onload = function() {
            if (!shortCode) {
                window.location.href = '/';
                return;
            }
            
            const data = getRedirectData(shortCode);
            
            if (data) {
                // Increment click count (simulated)
                data.clicks = (data.clicks || 0) + 1;
                localStorage.setItem(`pgxl_${shortCode}`, JSON.stringify(data));
                
                handleRedirect(data);
            } else {
                document.getElementById('redirectContainer').innerHTML = `
                    <h1>Link Not Found</h1>
                    <p>The short URL you're looking for doesn't exist or has expired.</p>
                    <button onclick="window.location.href='/'">Go to Homepage</button>
                `;
            }
        };
    </script>
</body>
</html>
