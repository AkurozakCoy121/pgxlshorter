<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PGXL | Financial Mastery Game</title>
    
    <!-- FIREBASE SDK MODULAR (FIXED) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithRedirect,
            getRedirectResult,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            collection,
            query,
            orderBy,
            limit,
            getDocs
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        // ==================== CONFIGURASI ====================
        const firebaseConfig = {
            apiKey: "AIzaSyCH5nmdOf3tL7HNjx9kqBmISgaylG8vvOU",
            authDomain: "pgxl-4567a.firebaseapp.com",
            projectId: "pgxl-4567a",
            storageBucket: "pgxl-4567a.firebasestorage.app",
            messagingSenderId: "545920930826",
            appId: "1:545920930826:web:18458fd3382a83f17abbf3",
            measurementId: "G-1Y4E635M4R"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        
        // ==================== AUTH FUNCTIONS ====================
        window.googleLogin = async function() {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithRedirect(auth, provider);
            } catch (error) {
                console.error("Login error:", error);
                alert("Login gagal: " + error.message);
            }
        };
        
        window.logout = async function() {
            if (confirm("Yakin ingin logout?")) {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout error:", error);
                }
            }
        };
        
        // Handle redirect result
        getRedirectResult(auth).then((result) => {
            if (result) {
                console.log("Login via redirect berhasil");
                window.location.reload();
            }
        }).catch((error) => {
            console.error("Redirect error:", error);
        });
        
        // Listen for auth state changes
        onAuthStateChanged(auth, async (user) => {
            window.currentUser = user;
            if (user) {
                await window.loadUserData(user);
                window.renderDashboard();
            } else {
                window.renderLandingPage();
            }
        });
    </script>
    
    <!-- HTML2CANVAS -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    
    <style>
        /* [SAMA PERSIS DENGAN CSS DI ATAS] */
        /* Copy semua CSS dari kode sebelumnya */
    </style>
</head>
<body>
    <!-- [SAMA PERSIS DENGAN HTML DI ATAS] -->
    <!-- Copy semua HTML dari kode sebelumnya -->
    
    <script>
        // ==================== GLOBAL VARIABLES ====================
        let currentUser = null;
        let userData = null;
        let currentStageKey = null;
        let selectedAnswer = null;
        
        // ==================== GAME DATA ====================
        const gameData = {
            totalLevels: 5,
            stagesPerLevel: 10,
            totalStages: 50,
            
            levelTitles: {
                1: "Dasar-dasar Keuangan",
                2: "Anggaran & Tabungan", 
                3: "Investasi Pemula",
                4: "Manajemen Utang",
                5: "Perencanaan Masa Depan"
            },
            
            stages: {
                // LEVEL 1
                "1_1": {
                    title: "Pengenalan Pengelolaan Uang",
                    content: `<h3>üí∞ Apa itu Pengelolaan Uang?</h3>
                    <p>Pengelolaan uang adalah seni dan ilmu dalam merencanakan, mengatur, dan mengendalikan penggunaan uang untuk mencapai tujuan keuangan.</p>`,
                    question: "Apa langkah pertama dalam pengelolaan uang yang baik?",
                    options: [
                        "Membeli saham mahal",
                        "Mencatat semua pemasukan dan pengeluaran",
                        "Mengajukan kartu kredit",
                        "Menabung tanpa tujuan"
                    ],
                    correctAnswer: 1,
                    clue: "Anda tidak bisa mengelola apa yang tidak Anda ukur.",
                    xpReward: 10
                },
                // ... tambahkan stage lainnya
                "5_10": {
                    title: "Ujian Akhir Financial Mastery",
                    content: `<h3>üéì FINAL TEST: Financial Mastery</h3>
                    <p>Selamat! Anda telah sampai di tahap terakhir dari 50 tahap.</p>`,
                    question: "Apa strategi terbaik untuk mencapai kebebasan finansial?",
                    options: [
                        "Menabung saja tanpa investasi",
                        "Investasi konsisten + penghasilan pasif + pengelolaan risiko",
                        "Bergantung pada warisan orang tua",
                        "Beli lotre setiap minggu"
                    ],
                    correctAnswer: 1,
                    clue: "Konsistensi, passive income, dan manajemen risiko.",
                    xpReward: 50
                }
            }
        };
        
        // ==================== FIRESTORE OPERATIONS ====================
        window.loadUserData = async function(user) {
            try {
                const userRef = doc(window.firebaseDb, 'users', user.uid);
                const userDoc = await getDoc(userRef);
                
                if (!userDoc.exists()) {
                    // Create new user data
                    userData = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || user.email,
                        photoURL: user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email)}&background=random`,
                        createdAt: new Date().toISOString(),
                        totalXP: 0,
                        level: 1,
                        completedStages: {},
                        currentStage: "1_1",
                        lastLogin: new Date().toISOString()
                    };
                    
                    await setDoc(userRef, userData);
                } else {
                    userData = userDoc.data();
                    // Update last login
                    await updateDoc(userRef, {
                        lastLogin: new Date().toISOString()
                    });
                }
                
                currentUser = user;
                
            } catch (error) {
                console.error("Error loading user data:", error);
            }
        };
        
        window.saveProgress = async function(stageKey, isCorrect) {
            if (!currentUser || !userData) return 0;
            
            try {
                const userRef = doc(window.firebaseDb, 'users', currentUser.uid);
                const stageData = gameData.stages[stageKey];
                
                // Update completed stages
                const completedStages = { ...userData.completedStages };
                completedStages[stageKey] = {
                    completed: true,
                    isCorrect: isCorrect,
                    completedAt: new Date().toISOString(),
                    xpEarned: isCorrect ? stageData.xpReward : 0
                };
                
                // Calculate new XP and level
                let newXP = userData.totalXP;
                if (isCorrect) {
                    newXP += stageData.xpReward;
                }
                
                const newLevel = Math.floor(newXP / 100) + 1;
                
                // Update user data
                const updates = {
                    totalXP: newXP,
                    level: newLevel,
                    completedStages: completedStages,
                    lastUpdated: new Date().toISOString()
                };
                
                await updateDoc(userRef, updates);
                
                // Update local data
                userData = { ...userData, ...updates };
                
                return isCorrect ? stageData.xpReward : 0;
                
            } catch (error) {
                console.error("Error saving progress:", error);
                return 0;
            }
        };
        
        // ==================== UI FUNCTIONS ====================
        window.renderLandingPage = function() {
            document.getElementById('main-content').innerHTML = `
                <div class="landing">
                    <h1>üéÆ PGXL Financial Mastery</h1>
                    <p class="landing-subtitle">
                        Kuasai keuangan Anda dalam 50 tahap interaktif.
                    </p>
                    
                    <button class="btn btn-primary" onclick="googleLogin()" style="padding: 12px 24px; font-size: 16px;">
                        üîê Login dengan Google
                    </button>
                </div>
            `;
            
            document.getElementById('nav-controls').innerHTML = `
                <button class="btn" onclick="googleLogin()">Login</button>
            `;
        };
        
        window.renderDashboard = function() {
            if (!userData) return;
            
            document.getElementById('main-content').innerHTML = `
                <div class="dashboard">
                    <h1>Selamat Datang, ${userData.displayName}!</h1>
                    <p>XP: ${userData.totalXP} | Level: ${userData.level}</p>
                    <button onclick="openStage('1_1')">Mulai Game</button>
                </div>
            `;
            
            document.getElementById('nav-controls').innerHTML = `
                <div class="user-info">
                    <img src="${userData.photoURL}" alt="Avatar" class="avatar">
                    <span>${userData.displayName}</span>
                </div>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            `;
        };
        
        window.openStage = function(stageKey) {
            const stageData = gameData.stages[stageKey];
            if (!stageData) {
                alert("Stage belum tersedia!");
                return;
            }
            
            currentStageKey = stageKey;
            selectedAnswer = null;
            
            document.getElementById('modal-title').textContent = stageData.title;
            
            document.getElementById('modal-body').innerHTML = `
                <div class="quiz-content">
                    ${stageData.content}
                    
                    <div class="question">${stageData.question}</div>
                    
                    <div class="options" id="options-container">
                        ${stageData.options.map((option, index) => `
                            <div class="option" onclick="selectAnswer(${index})" id="option-${index}">
                                <span class="option-label">${String.fromCharCode(65 + index)}</span>
                                ${option}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="clue-box">
                        <div class="clue-title">üí° Clue</div>
                        <p>${stageData.clue}</p>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="submit-btn" onclick="submitAnswer()" disabled>
                    Submit Jawaban
                </button>
                
                <div id="result-container"></div>
            `;
            
            document.getElementById('stage-modal').style.display = 'flex';
        };
        
        window.selectAnswer = function(index) {
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            document.getElementById(`option-${index}`).classList.add('selected');
            selectedAnswer = index;
            document.getElementById('submit-btn').disabled = false;
        };
        
        window.submitAnswer = async function() {
            if (selectedAnswer === null || !currentStageKey) return;
            
            const stageData = gameData.stages[currentStageKey];
            const isCorrect = selectedAnswer === stageData.correctAnswer;
            
            // Show result
            document.querySelectorAll('.option').forEach((opt, index) => {
                if (index === stageData.correctAnswer) {
                    opt.classList.add('correct');
                } else if (index === selectedAnswer && !isCorrect) {
                    opt.classList.add('incorrect');
                }
                opt.style.pointerEvents = 'none';
            });
            
            document.getElementById('submit-btn').disabled = true;
            
            // Save progress
            const xpEarned = await window.saveProgress(currentStageKey, isCorrect);
            
            // Show result message
            const resultContainer = document.getElementById('result-container');
            resultContainer.innerHTML = '';
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${isCorrect ? 'result-success' : 'result-fail'}`;
            
            if (isCorrect) {
                resultDiv.innerHTML = `
                    <div class="result-title">‚úÖ Jawaban Benar!</div>
                    <p class="xp-reward">+${xpEarned} XP</p>
                    <button class="btn btn-primary" onclick="closeModal()">
                        Tutup
                    </button>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="result-title">‚ùå Jawaban Salah</div>
                    <p>Coba lagi lain kali!</p>
                    <button class="btn" onclick="closeModal()">
                        Tutup
                    </button>
                `;
            }
            
            resultContainer.appendChild(resultDiv);
        };
        
        window.closeModal = function() {
            document.getElementById('stage-modal').style.display = 'none';
            document.getElementById('certificate-modal').style.display = 'none';
            window.renderDashboard();
        };
        
        // Expose functions
        window.openLevel = function(level) {
            window.openStage(`${level}_1`);
        };
        
        // Initial render
        if (!currentUser) {
            window.renderLandingPage();
        }
    </script>
</body>
</html>
